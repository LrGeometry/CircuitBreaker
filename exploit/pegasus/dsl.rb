class PegasusDSL < SwitchDSL
  def initialize(remote)
    super()
    @remote = remote
  end

  attr_accessor :remote
  
  def command(a, b, &block)
    @remote.command(a, b, &block)
  end
  
  def read(pointer, offset, length, &block)
    @remote.command("read", {:address => pack64(pointer.value+offset), :length => length}, &block)
  end

  def write(pointer, offset, data)
    @remote.command("write", {:address => pack64(pointer.value+offset), :payload => Base64.strict_encode64(data)})
  end
  
  def base_addr
    @base_addr||= make_pointer(unpack64(@remote.command("get", {:field => "baseAddr"})["value"]))
  end
  
  def main_addr
    @main_addr||= make_pointer(unpack64(@remote.command("get", {:field => "mainAddr"})["value"]))
  end
  
  def sp
    @sp||= make_pointer(unpack64(@remote.command("get", {:field => "sp"})["value"]))
  end

  def tls
    @tls||= make_pointer(unpack64(@remote.command("get", {:field => "tls"})["value"]))
  end

  def unpack64(pair)
    pair.pack("L<L<").unpack("Q<")[0]
  end

  def pack64(val)
    [val].pack("Q<").unpack("L<L<")
  end
  
  def mref(off)
    main_addr + off
  end
  
  def invoke_gc
    @remote.command("invokeGC", {})
    nil
  end
  
  def malloc(size)
    make_pointer(unpack64(@remote.command("malloc", {:length => size})["address"]))
  end

  def free(pointer)
    @remote.command("free", {:address => pack64(pointer.value)})
  end

  def call(func_ptr, int_args, registers, float_args)
    unpack64(@remote.command("invokeBridge", {
                               :funcPtr => pack64(func_ptr.value),
                               :intArgs => int_args.map do |v| pack64(v) end,
                               :registers => registers.map do |v| pack64(v) end,
                               :floatArgs => float_args.map do |v| pack64(v) end
                             })["returnValue"])
  end
  
  def jsrepl
    require "readline"
    while buf = Readline.readline("> ", true) do
      if buf == "exit" || buf == "quit" then
        break
      else
        puts @remote.command("eval", {:code => buf})["returnValue"]
      end
    end
  end
end
